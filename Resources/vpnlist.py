import requests, json, io

country_dict = {}

try:
    vpn_data = requests.get('http://www.vpngate.net/api/iphone/').text.replace('\r','')
    servers = [line.split(',') for line in vpn_data.split('\n')]
    labels = servers[1]
    labels[0] = labels[0][1:]
    servers = [s for s in servers[2:] if len(s) > 1]
except:
    print 'Cannot get VPN servers data'
    exit(1)

servers.pop(0)
servers.pop(1)
for server in servers:
    val_dict = {}
    val_dict["hostname"] = server[0]
    val_dict["ip"] = server[1]
    val_dict["score"] = server[2]
    val_dict["ping"] = server[3]
    val_dict["speed"] = server[4]
    val_dict["counter_code"] = server[6]
    if len(server[14]) == 0: #not supported by OpenVPN
        continue
    val_dict["openvpn_configdata_base64"] = server[14]
    array = country_dict.get(server[5], [])
    array.append(val_dict)
    country_dict[server[5]] = array

with open("./vpnlist.json", "w") as outfile:
    json.dump(country_dict, outfile, sort_keys=True, indent=4, ensure_ascii=False)

print "Done!"